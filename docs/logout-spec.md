# ログアウト機能 仕様書

## 概要
認証済みユーザーがアプリケーションからログアウトできる機能を提供する。
**React Router v7のactionパターン**を使用し、サーバーサイドでセッション無効化を行う。

## 要件

### 機能要件
- 認証済みユーザーがログアウトボタンをクリックできる
- ログアウト処理でサーバーサイドのセッション（HTTPOnlyクッキー）を無効化する
- ログアウト成功時はログイン画面に自動リダイレクトする
- ログアウト後は保護されたページにアクセスできなくする
- ログアウト処理中のローディング状態を表示する

### 非機能要件
- HTTPOnlyクッキーの適切な削除
- セッション無効化の確実な実行
- ログアウト処理の高速化（500ms以内）
- セキュアなログアウト処理（CSRF対策）

## インターフェース

### 入力
- **ログアウトボタン**: ダッシュボード画面からの操作
- **操作方法**: Formコンポーネントによるサーバーアクション実行

### 出力
- **ログアウト成功時**
  - HTTP 302 Redirect to `/login`
  - Set-Cookie: `nanika_game_user=; Path=/; HttpOnly; Max-Age=0`
  - ログイン画面への自動遷移

- **ログアウト失敗時**
  - HTTP 500 Internal Server Error
  - error: "ログアウトに失敗しました"
  - 現在の画面に留まりエラー表示

## データフロー

### ログアウト処理フロー（React Router v7パターン）
1. ユーザーがログアウトボタンをクリック
2. **Formコンポーネント**がサーバーアクションを実行
3. **action関数**がサーバーサイドでCookie削除処理
4. **redirect**でログイン画面にリダイレクト
5. ログイン画面の**loader**で認証状態確認（未認証として処理）

### 技術実装詳細
**サーバーサイド処理**：
- `app/routes/dashboard.tsx` - ログアウトaction追加
- HTTPOnlyクッキーの削除
- `/login`へのサーバーサイドリダイレクト

**クライアントサイド**：
- React RouterのFormコンポーネント使用
- ローディング状態のUI表示
- フォームベースの操作

## ビジネスルール

### ログアウト実行条件
1. **認証済み状態**: 有効なセッションCookieが存在する
2. **正常なブラウザ環境**: JavaScriptが有効
3. **ネットワーク接続**: サーバーとの通信が可能

### ログアウト後の制約
1. **保護されたページへのアクセス禁止**: `/dashboard`等へのアクセス時に`/login`にリダイレクト
2. **セッション完全削除**: サーバー・クライアント両方でセッション情報を削除
3. **ブラウザバック制御**: ログアウト後にブラウザバックで保護ページに戻れない

### セキュリティ規則
1. **HTTPOnlyクッキー削除**: クライアントサイドからアクセス不可能な形で削除
2. **サーバーサイド処理**: 重要な処理はサーバーサイドで実行
3. **CSRF対策**: React RouterのFormアクションによる自動保護

## エラーケース

### システムエラー
- **E301**: ネットワークエラー（サーバー接続失敗）
- **E302**: サーバー内部エラー（Cookie削除失敗）
- **E303**: リダイレクト失敗

### ユーザーエラー
- **E311**: 既にログアウト済み（重複ログアウト）
- **E312**: 無効なセッション（期限切れ等）

### 対処方法
- **エラー発生時**: 現在の画面でエラーメッセージ表示
- **重複ログアウト**: ログイン画面へ無害にリダイレクト
- **ネットワークエラー**: 再試行ボタン表示

## セキュリティ考慮事項
- **サーバーサイド削除**: HTTPOnlyクッキーをサーバーサイドで確実に削除
- **CSRF耐性**: React RouterのFormアクションによる保護
- **セッション検証**: ログアウト前の有効セッション確認
- **リダイレクト検証**: 安全なリダイレクト先のみ許可

## パフォーマンス要件
- **応答時間**: ログアウト処理100ms以内
- **リダイレクト時間**: 画面遷移200ms以内  
- **UI応答性**: ボタンクリック即座のローディング表示