# Nanika Game - Claude協業ガイドライン

このファイルは、Claude Code（claude.ai/code）がこのリポジトリで作業する際のガイダンスを提供します。

## 1. プロジェクト概要

このプロジェクトは、React RouterをフロントエンドフレームワークとしたWebアプリケーションです。
将来的にサーバーサイドを追加する際は、クリーンアーキテクチャとDDDの原則に基づいて実装します。

## 2. 【最重要】開発プロセス - 必ず遵守すること

### 開発の絶対ルール

**以下のプロセスは例外なく必ず守ること。これらのルールを破ることは許されません。**

1. **仕様書ファースト（Specification First）**
   - いかなる実装も仕様書なしに開始してはならない
   - 仕様書は`.claude/00_project/docs/`ディレクトリに作成すること
   - 仕様書のファイル名: `機能名-spec.md`

2. **開発プロセスの文書化**
   - 仕様書作成後、`.claude/00_project/development-process/`ディレクトリに実装計画を記述
   - ファイル名: `機能名-process.md`
   - 実装の各ステップを詳細に記載

3. **TDD（Test-Driven Development）の徹底**
   - development-processを基にテストを**先に**作成
   - テストが**失敗することを確認**してから実装開始
   - Red → Green → Refactorサイクルを厳守

4. **変更時のルール**
   - 修正が必要な場合は**必ず仕様書から修正**
   - 変更内容をdevelopment-processに記録
   - 仕様書 → development-process → テスト → 実装の順序を厳守

5. **プログレス管理の徹底**
   - development-process内の全ての作業項目に**プログレス記号を必須で付与**
   - 作業開始時は 🔄（作業中）に変更
   - 作業完了時は即座に ✅（完了）に変更
   - 問題発生時は ❌（失敗/エラー）に変更し、問題内容を記録

### 開発フロー（この順序は絶対）

```
1. .claude/00_project/docs/機能名-spec.md を作成
   ↓
2. .claude/00_project/development-process/機能名-process.md を作成
   ↓
3. テストコードを作成（*.test.ts）
   ↓
4. テストが失敗することを確認（npm run test）
   ↓
5. 実装コードを作成
   ↓
6. テストが成功することを確認
   ↓
7. リファクタリング（必要に応じて）
```

### 仕様書テンプレート（.claude/00_project/docs/機能名-spec.md）

```markdown
# [機能名] 仕様書

## 概要
機能の目的と概要を記述

## 要件
- 機能要件1
- 機能要件2

## インターフェース
入力と出力の定義

## ビジネスルール
ロジックとバリデーション規則

## エラーケース
想定されるエラーとその処理
```

### 開発プロセステンプレート（.claude/00_project/development-process/機能名-process.md）

```markdown
# [機能名] 開発プロセス

## 📋 プログレス記号システム
- ✅ **完了** - 作業が完全に終了し、テスト済み
- 🔄 **作業中** - 現在進行中の作業（**同時に複数は禁止**）
- 📋 **実装予定** - 計画済みで順次実装予定の作業
- ⏸️ **実装保留** - 特定の理由により実装を保留中の作業
- ❌ **失敗/エラー** - 問題が発生した作業
- 🔍 **調査中** - 技術調査や設計検討中

## 技術調査・設計フェーズ
1. 🔍 技術スタック調査と選定
2. 🔍 アーキテクチャ設計
3. 🔍 データフロー設計
4. 🔍 UI/UX設計
5. 🔍 セキュリティ要件定義

## 実装ステップ

### フロントエンド
1. 📋 [具体的コンポーネント名] (`ファイルパス`)
2. 📋 [具体的コンポーネント名] (`ファイルパス`)
3. 📋 [ユーティリティ関数] (`ファイルパス`)
4. 📋 [カスタムフック] (`ファイルパス`)
5. 📋 [ルーティング設定] (`ファイルパス`)

### バックエンド（将来実装時）
1. 📋 [エンティティ定義] (`ファイルパス`)
2. 📋 [リポジトリインターフェース] (`ファイルパス`)
3. 📋 [ユースケース実装] (`ファイルパス`)
4. 📋 [コントローラー実装] (`ファイルパス`)
5. 📋 [API統合] (`ファイルパス`)

### データベース・インフラ
1. 📋 [テーブル設計] (`マイグレーションファイル`)
2. 📋 [初期データ作成] (`シードファイル`)
3. 📋 [環境設定] (`設定ファイル`)

## テストケース

### 正常系テスト
- 📋 [具体的なテストケース名]
- 📋 [具体的なテストケース名]
- 📋 [具体的なテストケース名]

### 異常系テスト  
- 📋 [エラーケースのテスト名]
- 📋 [バリデーションエラーのテスト]
- 📋 [境界値テスト]

### UI/UXテスト
- 📋 [レスポンシブデザイン確認]
- 📋 [アクセシビリティ確認]
- 📋 [ブラウザ互換性確認]

### パフォーマンステスト
- 📋 [ページ読み込み速度テスト]
- 📋 [大量データ処理テスト]
- 📋 [メモリリークテスト]

## 実装順序（厳守）
1. 📋 技術調査・設計フェーズ完了
2. 📋 テストファイル作成（失敗確認）
3. 📋 フロントエンド実装
4. 📋 バックエンド実装（将来）
5. 📋 統合テスト
6. 📋 パフォーマンス最適化
7. 📋 最終テスト・デプロイ準備

## 技術スタック
- **フロントエンド**: [使用技術]
- **バックエンド**: [使用技術]
- **データベース**: [使用技術]
- **認証**: [使用技術]
- **デプロイ**: [使用技術]

## セキュリティ要件
- 📋 [具体的なセキュリティ要件1]
- 📋 [具体的なセキュリティ要件2]
- 📋 [具体的なセキュリティ要件3]

## パフォーマンス目標
- **ページ読み込み時間**: [目標値]秒以内
- **API応答時間**: [目標値]ms以内
- **同時接続数**: [目標値]まで対応

## 既知のリスクと対策
- 📋 **リスク1**: [具体的なリスク] → **対策**: [対策内容]
- 📋 **リスク2**: [具体的なリスク] → **対策**: [対策内容]

## 変更履歴
- YYYY-MM-DD: プロセス計画作成（プログレス管理開始）
- YYYY-MM-DD: [変更内容]
```

## 3. アーキテクチャ設計思想

このプロジェクトは**DDD（ドメイン駆動設計）とクリーンアーキテクチャ**に従います。

### 基本原則
- **クリーンアーキテクチャ**: 関心事の分離を徹底し、依存関係の方向を常に内側（ドメイン）に向ける
- **依存性のルール**: 
  - ✅ OK: `application` → `domain`, `infrastructure` → `domain`
  - ❌ NG: `domain` → `application`, `domain` → `infrastructure`
- **テスト可能性**: すべてのビジネスロジックは独立してテスト可能に
- **TDD**: テスト駆動開発を必須とする

### 主要な設計パターン

1. **リポジトリパターン**: インターフェースの背後でデータアクセスを抽象化
2. **ユースケースパターン**: 各ビジネス操作は個別のユースケース
3. **値オブジェクト**: バリデーションをカプセル化
4. **Server/Client コンポーネント分離**: パフォーマンスの最適化
5. **複合コンポーネント**: 複雑なUI用

## 4. ディレクトリ構造

### 現在の構造
```
/
├── .claude/               # プロジェクトドキュメント
│   ├── 00_project/       # プロジェクトコンセプトと要件
│   │   ├── docs/        # 仕様書（必須）
│   │   │   └── 機能名-spec.md
│   │   ├── development-process/ # 開発プロセス記録（必須）
│   │   │   └── 機能名-process.md
│   │   └── reports/     # 分析レポート
│   ├── 01_development_docs/ # 技術設計ドキュメント
│   ├── 02_design_system/ # デザインシステム
│   └── 03_library_docs/  # ライブラリドキュメント
├── app/                   # アプリケーションディレクトリ
│   ├── web/              # フロントエンド（React Router）
│   │   ├── routes/       # ページコンポーネント
│   │   ├── components/   # 共通コンポーネント
│   │   ├── hooks/        # カスタムフック
│   │   ├── utils/        # ユーティリティ関数
│   │   ├── types/        # 型定義
│   │   └── app.css       # スタイル
│   ├── api/              # バックエンドAPI（将来実装時）
│   │   ├── application/  # Usecase層
│   │   ├── controllers/  # HTTPコントローラー
│   │   ├── infrastructure/ # インフラ層
│   │   ├── dtos/        # Data Transfer Objects
│   │   └── middlewares/  # ミドルウェア
│   ├── domain/           # ドメイン層（共有）
│   │   ├── entities/     # エンティティ
│   │   ├── repositories/ # リポジトリI/F
│   │   ├── services/     # ドメインサービス
│   │   └── value-objects/ # 値オブジェクト
│   ├── shared/           # 共有ユーティリティ
│   │   ├── errors/       # カスタムエラー
│   │   └── types/        # 共通型定義
│   ├── root.tsx          # エントリーポイント
│   └── routes.ts         # ルーティング設定
├── public/               # 静的ファイル
├── prisma/               # Prismaスキーマ
└── 設定ファイル群
```

## 5. コーディング規約

### 基本ルール
- **インデント**: スペース2つ
- **文字コード**: UTF-8
- **改行コード**: LF
- **セミコロン**: 必須
- **クォート**: シングルクォート優先

### TypeScript
- 型定義は必須（`any`型の使用禁止）
- 関数にはJSDocコメントを追加
- エラーハンドリングは必須
- 早期リターンを活用
- インターフェースは`I`プレフィックス（例: `IUserRepository`）
- 実装クラスは`Impl`サフィックス（例: `UserRepositoryImpl`）

### React
- 関数コンポーネントを使用
- カスタムフックは`use`プレフィックス
- propsには型定義を必須
- コンポーネントファイルはPascalCase

### テスト
- ファイル名: `.test.ts` または `.spec.ts`
- `describe`と`it`で構造化
- 正常系・異常系の両方をテスト
- モックは最小限に

### エラーハンドリング
- カスタムエラークラスを使用（`shared/errors`に定義）
- Usecase層とInfrastructure層でエラーをthrow
- Controller層でHTTPステータスコードに変換

## 6. 各レイヤーの責務

### Domain層（app/domain）
- **entities**: ビジネスエンティティ（状態と振る舞い）
- **repositories**: データ永続化のインターフェース定義
- **services**: ドメインサービス
- **value-objects**: 値オブジェクト
- **ルール**: フレームワーク非依存、純粋なTypeScript

### Application層（app/api/application）
- **責務**: ユースケースの実装
- **ルール**: 
  - DIによる依存性注入
  - フレームワーク固有オブジェクト（req, res）に依存しない
  - ドメインエンティティを利用してビジネスフローを構築

### Infrastructure層（app/api/infrastructure）
- **persistence**: DB実装（Prisma, TypeORM等）
- **services**: 外部APIクライアント
- **責務**: リポジトリインターフェースの実装

### Controller層（app/api/controllers）
- **責務**: HTTPリクエスト/レスポンスの処理
- **ルール**:
  - リクエストバリデーション
  - DTOを介したデータ受け渡し
  - ビジネスロジックを含まない

## 7. 新機能追加フロー

### フロントエンド機能（この順序を厳守）
1. `.claude/00_project/docs/機能名-spec.md` で仕様書を作成
2. `.claude/00_project/development-process/機能名-process.md` で実装プロセスを記録
3. テストファイルを作成（`*.test.ts`）
4. テストが失敗することを確認
5. `app/routes.ts`にルーティングを追加（必要に応じて）
6. `app/web/routes/`にページコンポーネントを実装
7. `app/web/components/`に共通コンポーネントを実装（必要に応じて）
8. `app/web/utils/`または`app/web/hooks/`にロジックを実装
9. テストが成功することを確認
10. リファクタリング（必要に応じて）

### バックエンドAPI（この順序を厳守）
1. `.claude/00_project/docs/api/機能名-spec.md` で仕様書を作成
2. `.claude/00_project/development-process/api/機能名-process.md` で実装プロセスを記録
3. `oas/`にOpenAPI仕様を定義
4. テストファイルを作成（各レイヤー毎に）
5. テストが失敗することを確認
6. `app/domain/entities/`にエンティティを定義
7. `app/domain/repositories/`にリポジトリI/Fを定義
8. `app/api/application/`にUsecaseを実装
9. `app/api/infrastructure/`にリポジトリ実装
10. `app/api/controllers/`にコントローラーを実装
11. `app/api/main.ts`でDIとルーティング設定
12. テストが成功することを確認
13. リファクタリング（必要に応じて）

## 8. コミットメッセージ
- 日本語OK
- プレフィックスを使用:
  - `feat:` 新機能
  - `fix:` バグ修正
  - `refactor:` リファクタリング
  - `test:` テスト追加・修正
  - `docs:` ドキュメント更新
  - `style:` フォーマット修正
  - `chore:` その他の変更

## 9. 禁止事項

### 🚨 開発プロセス違反（最重要）
- **仕様書なしでの実装開始**（絶対禁止）
- **テストなしでの実装開始**（絶対禁止）
- **仕様変更時に仕様書を更新しないこと**（絶対禁止）
- **development-processの記録を怠ること**（絶対禁止）
- **プログレス記号の更新を忘れること**（絶対禁止）
- **作業完了時に記号を ✅ に変更しないこと**（絶対禁止）

### コード品質違反
- console.logの本番コード残留
- コメントアウトされたコードの残留
- 未使用の変数・インポート
- マジックナンバーの直接使用
- any型の使用
- ビジネスロジックのController層への記述

## 10. 開発コマンド

```bash
# 開発
npm run dev

# 品質チェック（コミット前に実行）
npm run format            # Biomeフォーマット
npm run lint              # Biome Lint
npm run typecheck         # TypeScript型チェック
npm run test              # Vitestテスト実行

# ビルド
npm run build             # プロダクションビルド

# データベースコマンド
# npm run db:migrate      # マイグレーション実行
# npm run db:seed         # テストデータ投入
```

## 11. 必須ツール

- **Biome**: フォーマッター・リンター
- **Vitest**: テスト
- **TypeScript**: 型チェック
- **React Router**: フロントエンドフレームワーク

## 12. 環境セットアップ

### GitHub Codespaces環境での自動セットアップ
```bash
# クイックセットアップ（DB起動・マイグレーション・シード・サーバー起動）
npm run setup

# フルセットアップ（依存関係インストール含む）
npm run setup:full
```

### 手動セットアップ
1. 依存関係のインストール
   ```bash
   npm install
   ```

2. 環境変数の設定
   ```bash
   # .envファイルが存在しない場合のみ作成
   if [ ! -f .env ]; then
     cat > .env << EOF
# Database
DATABASE_URL="postgresql://nanika_user:nanika_password@localhost:5432/nanika_game?schema=public"

# Application
NODE_ENV=development
EOF
   fi
   ```

3. PostgreSQLデータベースの起動（Docker使用）
   ```bash
   docker compose up -d postgres
   ```

4. データベースのセットアップ
   ```bash
   # マイグレーションの実行
   npm run db:migrate
   
   # シードデータの投入
   npm run db:seed
   
   # または一括実行
   npm run db:setup
   ```

5. 開発サーバーの起動
   ```bash
   npm run dev
   ```

### データベースのシードデータ
`prisma/seed.ts`により、以下のテストユーザーが自動作成されます：
- 管理者: admin@example.com / admin123
- ユーザー1: user1@example.com / password123
- ユーザー2: user2@example.com / password123
- ゲスト: guest@example.com / guest123

### データベース確認方法
```bash
# Prisma Studio（GUI）
npx prisma studio

# psqlコマンド（CLI）
docker exec nanika-game-db psql -U nanika_user -d nanika_game -c "SELECT * FROM users;"

# スクリプト実行
npx tsx scripts/check-db.ts
```

## 13. コアビジネスエンティティ

### 現在のエンティティ
- **User**: ゲームプレイヤー
- **Game**: ゲームセッション
- **Character**: ゲーム内キャラクター

### 追加エンティティ
- **Item**: ゲーム内アイテム
- **Achievement**: 実績システム
- **Leaderboard**: ランキング機能
- **SaveData**: セーブデータ管理

## 14. テスト戦略

このプロジェクトは**TDD（テスト駆動開発）**と**ゼロ警告ポリシー**に従います。

```
__tests__/
├── unit/                 # 高速な単体テスト（ドメイン層90%カバレッジ目標）
├── integration/          # APIとリポジトリのテスト
└── fixtures/            # テストデータとモック
```

テストを先に書き、テスト実行中のコンソール警告/エラーをゼロにします。

## 15. 開発前チェックリスト

### 🔥 開発プロセス確認（必須）
- [ ] `.claude/00_project/docs/機能名-spec.md` が作成済み
- [ ] `.claude/00_project/development-process/機能名-process.md` が作成済み
- [ ] 全ての作業項目にプログレス記号（⏸️、🔍等）が付与済み
- [ ] テストファイルが作成済み
- [ ] テストが失敗することを確認済み

### コード品質確認
- [ ] `npm run format` でフォーマット
- [ ] `npm run lint` でリントチェック  
- [ ] `npm run typecheck` で型チェック
- [ ] `npm run test` でテスト実行
- [ ] エラーハンドリングの実装確認
- [ ] 適切なレイヤーへの配置確認

## 16. データベーススキーマ

PostgreSQL/Prisma/Supabaseを使用予定。以下の設計原則に従う：

### 主要テーブル構造
- `users`: ユーザーアカウント
- `games`: ゲームセッション
- `characters`: キャラクター情報
- `items`: アイテムマスターデータ
- `user_items`: ユーザー所持アイテム

### 設計原則
- すべてのテーブルはUUID主キーを使用
- `created_at`、`updated_at`タイムスタンプを標準装備
- `deleted_at`によるソフトデリート実装
- 外部キー制約による参照整合性の保証
- インデックスによるクエリ最適化

### マイグレーション戦略
```bash
# npm run db:generate     # DBからTypeScript型を生成
# npm run db:migrate      # マイグレーション適用
# npm run db:seed         # テストデータ投入
```

## 17. 重要な設計上の決定

1. **型安全性**: `any`型を使用しない厳密なTypeScript
2. **エラーハンドリング**: カスタムエラークラスを使用した構造化エラー処理
3. **パフォーマンス**: 必要に応じてコード分割と遅延読み込みを使用
4. **アクセシビリティ**: WCAG 2.1 AA準拠を目指す
5. **レスポンシブデザイン**: モバイルファーストアプローチ
6. **SEOファースト**: 重要ページは適切なメタタグでサーバーレンダリング
7. **最小限の入力**: ユーザー登録に必要な情報を最小限に
8. **プログレッシブエンハンスメント**: 基本機能はJavaScript無効でも動作

## 18. API設計

一貫したレスポンス形式のRESTfulエンドポイント：
```json
{
  "success": true,
  "data": { ... },
  "meta": { "timestamp": "..." }
}
```

エラーレスポンス：
```json
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "ユーザーフレンドリーなメッセージ"
  }
}
```

## 19. フロントエンドガイドライン

### 基本原則
- **Server Components優先**: デフォルトでServer Componentsを使用
- **Client Components**: 必要な場合のみ`'use client'`を使用（フォーム、インタラクティブ性）
- **コンポーネント設計**: 再利用性のためにジェネリックコンポーネント + アダプターパターン
- **スタイリング**: Tailwind CSSとCVA（Class Variance Authority）を使用
- **状態管理**: 必要最小限のグローバル状態、ローカル状態を優先

### UIコンポーネント規約
- 適切なローディングとエラー状態を実装
- モバイルファーストのレスポンシブデザイン
- アクセシビリティ属性（aria-label、role等）を適切に設定
- フォームには適切なバリデーションとエラーメッセージ
- 複合コンポーネントパターン（Card.Header、Card.Body等）を活用

### パフォーマンス最適化
- 画像の遅延読み込み（lazy loading）
- コード分割（dynamic import）
- メモ化（React.memo、useMemo、useCallback）の適切な使用
- 仮想スクロール（大量リスト表示時）

### React Routerベストプラクティス
- ルート定義は`app/routes.ts`に集約
- ローダー/アクションパターンの活用
- エラーバウンダリーの実装
- 適切なメタデータ設定（title、description）

## 20. 避けるべき一般的な落とし穴

1. ServerとClient Components間でクラスインスタンスを渡さない（プレーンオブジェクトにシリアライズ）
2. `grep`や`find`コマンドを使わない - 代わりにGrep/Globツールを使用
3. ファイルを書く前に必ず存在を確認（WriteよりEditを優先）
4. コードをコミットする前に`npm run format && npm run lint && npm run typecheck`を実行
5. コンポーネントは小さく、単一責任に集中させる
6. console.logの本番コード残留を避ける
7. コメントアウトされたコードの残留を避ける

## 21. 🚀 コミュニケーション効率化・改善プロセス

**参照**: `.claude/00_project/reports/communication-improvement-analysis.md`

### 実装前必須フェーズ

#### A. 技術調査フェーズ（実装開始前必須）
```markdown
## 技術調査チェックリスト
- [ ] 使用技術スタックの公式ドキュメント確認
- [ ] 選択した技術でのベストプラクティス調査  
- [ ] サンプルコード・チュートリアルの実践
- [ ] 技術的制約・注意点の洗い出し
- [ ] 代替アプローチの検討と比較
- [ ] PoC（概念実証）の実施（1-2時間程度）
```

#### B. 設計レビューフェーズ（実装開始前必須）
```markdown
## 設計レビューチェックリスト
- [ ] アーキテクチャ図の作成
- [ ] データフローの明確化
- [ ] セキュリティ要件の具体化
- [ ] エラーハンドリング戦略の策定
- [ ] テスト戦略の策定
- [ ] 管理者への技術選択説明資料作成
```

### 実装中の文書化ルール

#### リアルタイム記録必須項目
```markdown
## 実装中必須アクション
1. **技術的課題発生時**: 即座にdevelopment-process/に課題と解決策を記録
2. **設計変更時**: 即座にdocs/仕様書を更新
3. **新しいファイル作成時**: 即座にREADMEまたは仕様書に追記
4. **エラー解決時**: 解決策をナレッジとして蓄積
5. **実装方針変更時**: 変更理由と影響範囲を記録
```

### 管理者確認ポイントの標準化

#### 実装開始前確認事項（管理者承認必須）
```markdown
## 技術選択確認シート
### 1. 技術選択の妥当性
- **選択した技術スタック**: [技術名]
- **選択理由**: [具体的理由]
- **代替案検討結果**: [A案 vs B案 比較]
- **PoC結果**: [実証結果・所要時間]

### 2. 実装アプローチ
- **アーキテクチャパターン**: [パターン名]
- **データフロー**: [フロー図・説明]
- **セキュリティ考慮事項**: [対策一覧]

### 3. リスク要因
- **技術的リスク**: [リスク一覧]
- **対策**: [対策一覧]  
- **代替プラン**: [プランB]
- **見積もり工数**: [時間]
```

### 段階的実装アプローチ

#### フェーズ分割戦略
1. **PoC（概念実証）フェーズ** (1-2時間)
   - 最小限の機能で技術的実現可能性を確認
   - 主要な技術的課題の洗い出し
   - 管理者への実現可能性報告

2. **MVP実装フェーズ** (主実装)
   - PoC結果を踏まえた本格実装
   - 継続的な仕様書・ログ更新

3. **改良フェーズ** (リファクタリング・機能追加)
   - パフォーマンス改善
   - セキュリティ強化

### 効果測定指標
- **管理者とのやり取り頻度**: 80%削減目標
- **技術的問題の事前回避率**: 90%以上
- **仕様書・ログの即時更新率**: 100%

## 22. 📋 プログレス管理システム（必須遵守）

### プログレス記号の定義と使用条件

#### ✅ **完了（COMPLETED）**
- **使用条件**: 作業が100%完了し、テストも成功している状態
- **変更タイミング**: テスト成功を確認した瞬間
- **例**: `1. ✅ ログイン画面コンポーネント実装 (app/routes/login.tsx)`
- **禁止事項**: 部分完了や未テスト状態での使用は厳禁

#### 🔄 **作業中（IN PROGRESS）**
- **使用条件**: 現在アクティブに作業している項目（**同時に1つまで**）
- **変更タイミング**: 作業を開始した瞬間
- **例**: `2. 🔄 ユーザー登録画面の実装中 (app/routes/register.tsx)`
- **重要**: 新しい作業を始める前に、必ず現在の🔄を完了または保留に変更

#### 📋 **実装予定（PLANNED）**
- **使用条件**: 計画済みで順次実装予定の通常作業
- **変更タイミング**: 初期計画時（特別な理由なし）
- **例**: `2. 📋 ユーザー登録画面コンポーネント (app/routes/register.tsx)`
- **特徴**: 理由記載不要、通常の開発フローで順次着手

#### ⏸️ **実装保留（ON HOLD）**
- **使用条件**: 特定の理由により実装を一時停止している作業
- **変更タイミング**: 保留要因が発生した時、または作業中断時
- **例**: `3. ⏸️ パスワードリセット機能 (理由: メール送信機能実装が前提) - 再開条件: SMTP設定完了`
- **必須記録**: 保留理由と再開条件を必ず記載
- **重要**: **必ず具体的な保留理由と再開条件**が必要

#### ❌ **失敗/エラー（FAILED/ERROR）**
- **使用条件**: 問題が発生し、作業が停止している状態
- **変更タイミング**: エラーが発生した瞬間
- **例**: `4. ❌ API統合でCORSエラー発生 - 原因: サーバー設定不備`
- **必須記録**: 問題内容と原因を詳細に記録
- **解決後**: 🔄に戻して作業再開、最終的に✅に変更

#### 🔍 **調査中（INVESTIGATING）**
- **使用条件**: 技術調査、設計検討、要件確認中
- **変更タイミング**: 調査・検討を開始した瞬間
- **例**: `5. 🔍 認証ライブラリの選定調査中 (Auth0 vs Clerk vs 自作)`
- **調査完了後**: ⏸️（実装待ち）または🔄（実装開始）に変更

### プログレス管理の厳格ルール

#### 🚨 絶対遵守事項（違反は開発プロセス違反）

1. **記号更新の即時性**
   ```markdown
   作業開始時：📋 → 🔄 （即座に変更）
   作業完了時：🔄 → ✅ （テスト成功後即座に変更）
   エラー発生時：🔄 → ❌ （問題発生と同時に変更）
   調査開始時：📋 → 🔍 （調査開始と同時に変更）
   保留発生時：📋 または 🔄 → ⏸️ （保留理由と再開条件を記載）
   ```

2. **同時作業の絶対制限**
   - 🔄（作業中）は**絶対に1つまで**
   - 例外なし、必ず現在の作業を完了または保留にしてから次の作業開始
   - **違反例**: `1. 🔄 ログイン機能` と `2. 🔄 登録機能` を同時進行

3. **完了条件の厳格化**
   - ✅への変更は**必ずテスト成功後**
   - 以下の場合は✅使用禁止：
     - コードは書いたがテストしていない
     - テストは通るが動作確認していない
     - 部分的に完了したが全体が未完成

4. **問題発生時の必須記録**
   ```markdown
   ## ❌記録の必須フォーマット
   X. ❌ [作業名] - 問題: [具体的な問題内容] - 原因: [判明した原因] - 対策: [取る予定の対策]
   
   ## 実例
   3. ❌ API認証エラー - 問題: 401 Unauthorized - 原因: JWTトークン期限切れ - 対策: リフレッシュトークン実装
   ```

### プログレス更新の実践例

#### 新機能開発の完全なフロー例
```markdown
## 実装ステップ（例：商品管理機能）

### 初期計画時（通常項目は📋でスタート）
1. 📋 商品一覧画面の実装 (app/routes/products.tsx)
2. 📋 商品詳細画面の実装 (app/routes/products.$id.tsx)  
3. 📋 商品追加機能の実装 (app/components/ProductForm.tsx)
4. 📋 商品API実装 (app/utils/product-api.ts)

### 作業開始（1つずつ🔄に変更）
1. 🔄 商品一覧画面の実装 (app/routes/products.tsx)
2. 📋 商品詳細画面の実装 (app/routes/products.$id.tsx)  
3. 📋 商品追加機能の実装 (app/components/ProductForm.tsx)
4. 📋 商品API実装 (app/utils/product-api.ts)

### 問題発生時（❌に即座に変更）
1. ❌ 商品一覧画面でスタイル崩れ - 問題: CSS Grid未対応 - 対策: Flexboxに変更
2. 📋 商品詳細画面の実装 (app/routes/products.$id.tsx)  
3. 📋 商品追加機能の実装 (app/components/ProductForm.tsx)
4. 📋 商品API実装 (app/utils/product-api.ts)

### 問題解決後（❌→🔄→✅）
1. ✅ 商品一覧画面の実装完了 (app/routes/products.tsx) - テスト通過確認
2. 🔄 商品詳細画面の実装中 (app/routes/products.$id.tsx)  
3. 📋 商品追加機能の実装 (app/components/ProductForm.tsx)
4. 📋 商品API実装 (app/utils/product-api.ts)
```

#### 調査フェーズの記録例
```markdown
## 技術調査フェーズ
1. 🔍 状態管理ライブラリの選定 (Redux vs Zustand vs Jotai)
   - Redux: 学習コストが高い、大規模向け
   - Zustand: シンプル、中規模向け  
   - Jotai: アトミック、小規模向け
   - 結論: Zustandを選定
   
2. 📋 状態管理の実装 (調査完了後に開始予定)
```

### 中断・再開時の詳細プロトコル

#### 中断時の必須記録フォーマット
```markdown
## 中断時の記録例
X. ⏸️ [作業名] (中断理由: [具体的な理由]) - 中断時点: [どこまで完了したか] - 再開時の注意点: [重要な引き継ぎ事項]

## 実例  
2. ⏸️ 決済機能実装 (中断理由: Stripe API調査必要) - 中断時点: フォーム作成完了 - 再開時の注意点: APIキー設定から開始
```

#### 再開時のチェックリスト
```markdown
## 作業再開時の確認事項
- [ ] 中断理由が解決されているか確認
- [ ] 中断時点の作業内容を確認
- [ ] 依存関係に変更がないか確認
- [ ] ⏸️ → 🔄 に変更してから作業開始
```

### よくある違反例と正しい対処法

#### ❌ 違反例1: 複数同時作業
```markdown
## 間違った例
1. 🔄 ログイン機能の実装
2. 🔄 登録機能の実装  ← これは禁止！
3. 📋 パスワードリセット機能

## 正しい例  
1. 🔄 ログイン機能の実装
2. 📋 登録機能の実装（ログイン完了後に開始予定）
3. ⏸️ パスワードリセット機能 (理由: メール送信機能実装が前提) - 再開条件: SMTP設定完了
```

#### ❌ 違反例2: 未テスト完了
```markdown
## 間違った例
1. ✅ ログイン機能の実装（コードは書いたがテストしてない）

## 正しい例
1. 🔄 ログイン機能の実装（テスト完了まで🔄を維持）
   ↓ (テスト成功後)
1. ✅ ログイン機能の実装（テスト通過確認済み）
```

#### ❌ 違反例3: 問題記録の不備
```markdown
## 間違った例  
1. ❌ API呼び出しエラー

## 正しい例
1. ❌ API呼び出しで500エラー - 問題: /api/users エンドポイントでInternal Server Error - 原因: DB接続設定不備 - 対策: 環境変数の設定確認
```

### 新機能追加時のプログレス管理チェックリスト

#### development-process/機能名-process.md 作成時の必須確認
```markdown
## プログレス管理チェックリスト（機能追加時）
- [ ] 全実装ステップに初期記号（📋、⏸️または🔍）を付与
- [ ] 全テストケースに初期記号（📋）を付与
- [ ] プログレス記号システムの説明セクションを含める
- [ ] 実装順序に記号を付与
- [ ] 変更履歴にプログレス管理開始日を記録
```

#### 新規processファイルの必須セクション
```markdown
## 必須セクション（テンプレート）
# [機能名] 開発プロセス

## 実装ステップ
1. 🔍 技術調査・設計検討
2. 📋 [具体的な実装項目]
...

## テストケース  
- 📋 [テストケース名]
...

## 📋 プログレス記号システム
- ✅ **完了** - 作業が完全に終了し、テスト済み
- 🔄 **作業中** - 現在進行中の作業（同時に複数は禁止）
- 📋 **実装予定** - 計画済みで順次実装予定の作業
- ⏸️ **実装保留** - 特定の理由により実装を保留中の作業
- ❌ **失敗/エラー** - 問題が発生した作業
- 🔍 **調査中** - 技術調査や設計検討中

## 変更履歴
- YYYY-MM-DD: プロセス計画作成（プログレス管理開始）
```

## 23. ⏸️ 保留理由の明記ルール（新規追加）

### 保留中と未実装の明確な区別

#### 🚨 重要な原則
**📋実装予定** と **⏸️実装保留** は明確に区別します。
- **📋実装予定**: 通常の開発フローで順次実装する項目（理由記載不要）
- **⏸️実装保留**: 特定の理由で実装できない項目（**必ず理由と再開条件を記載**）

#### 保留理由の分類と記載例

##### A. 技術的依存関係による保留（⏸️使用）
```markdown
## ⏸️実装保留の正しい記載例
- ⏸️ ユーザー登録画面 (理由: ログイン機能完了後に実装予定) - 再開条件: login.test.tsx成功
- ⏸️ パスワードリセット機能 (理由: メール送信機能実装が前提) - 再開条件: SMTP設定完了
- ⏸️ 商品編集機能 (理由: 商品一覧機能の完了後に着手) - 再開条件: 商品一覧テスト完了

## 📋実装予定の正しい記載例
- 📋 商品詳細画面 (app/routes/products.$id.tsx)
- 📋 ユーザープロフィール編集 (app/routes/profile.tsx) 
- 📋 検索機能 (app/components/SearchBox.tsx)
```

##### B. 要件未確定による保留
```markdown
## 正しい記載例  
- ⏸️ 決済機能 (理由: 決済方法の要件確定待ち)
- ⏸️ レポート機能 (理由: 出力形式の仕様検討中)
- ⏸️ 多言語対応 (理由: 対応言語の選定作業中)
```

##### C. リソース・優先度による保留
```markdown
## 正しい記載例
- ⏸️ UI/UXテスト (理由: MVP完成後に実施予定)
- ⏸️ パフォーマンス最適化 (理由: 基本機能優先のため後回し)
- ⏸️ アクセシビリティ対応 (理由: Phase2機能として予定)
```

##### D. 技術的制約による保留
```markdown
## 正しい記載例
- ⏸️ 自動テスト (理由: React Router v7テスト環境の技術的制約)
- ⏸️ リアルタイム通知 (理由: WebSocket環境構築が必要)
- ⏸️ モバイルアプリ (理由: Web版完成後に着手予定)
```

##### E. 外部要因による保留
```markdown
## 正しい記載例
- ⏸️ 本格的DB移行 (理由: 本番環境準備完了後に実施)
- ⏸️ SSL証明書設定 (理由: ドメイン取得完了後に実施)  
- ⏸️ 外部API連携 (理由: API提供元の仕様確定待ち)
```

#### ❌ 不適切な保留理由の例

```markdown
## 悪い記載例（理由が曖昧・不明確）
- ⏸️ ユーザー登録画面 (理由: 後で作る)
- ⏸️ テスト (理由: 面倒)
- ⏸️ レスポンシブ対応 (理由: 時間がない)
- ⏸️ エラーハンドリング (理由: 必要かわからない)
```

#### 保留理由記載の必須フォーマット

```markdown
## 標準フォーマット
X. ⏸️ [機能名] (理由: [具体的な保留理由]) - 再開条件: [再開に必要な条件]

## 実例
1. ⏸️ ユーザー登録画面実装 (理由: ログイン機能のテスト完了後に着手) - 再開条件: app/routes/login.test.tsx の成功確認
2. ⏸️ 決済機能 (理由: Stripe vs PayPal の選定会議結果待ち) - 再開条件: 管理者による決済方法確定
3. ⏸️ 自動テスト (理由: React Router v7のテスト環境設定に技術的課題) - 再開条件: テスト環境の代替手段確立
```

#### 保留状況の定期レビュー

##### 保留項目チェックリスト（週次確認推奨）
```markdown
## 保留項目レビュー項目
- [ ] 保留理由は今も有効か？
- [ ] 再開条件は満たされたか？
- [ ] 優先度に変更はないか？
- [ ] 新しい技術的解決策は見つかったか？
- [ ] 保留項目の数は適切か？（目安: 全体の30%以下）
```

##### 保留解除のプロトコル
```markdown
## 保留解除時の手順
1. 再開条件の満足を確認
2. ⏸️ → 🔍（調査必要な場合）または ⏸️ → 🔄（即座に実装開始）
3. 保留理由の部分を削除し、作業開始日を記録
4. 関連する他の保留項目への影響を確認

## 実例
変更前: 1. ⏸️ ユーザー登録画面 (理由: ログイン機能完了後に実装)
変更後: 1. 🔄 ユーザー登録画面 - 2025-08-09 作業開始
```

#### 保留管理のベストプラクティス

##### 1. 保留項目数の適切な管理
- 全実装項目の30%以下に保つ
- 長期保留項目（1ヶ月以上）は定期的にレビュー
- 保留理由が解消された項目は即座に実装開始

##### 2. 明確な再開条件の設定
- 曖昧な条件は避ける（「後で」「時間ができたら」等）
- 測定可能な条件を設定（「テスト成功」「仕様確定」等）
- 依存関係を明確に記録

##### 3. 保留項目の影響範囲管理
- 保留により影響を受ける他機能を特定
- 回避策や代替手段の検討
- 全体のプロジェクト進行への影響評価

### 保留理由記載の強制ルール

#### 🚨 violation（違反）となる例
```markdown
## 以下は開発プロセス違反
- ⏸️ ユーザー登録機能           ← 理由記載なし（違反）
- ⏸️ テスト (後で)             ← 理由が曖昧（違反） 
- ⏸️ UI改善 (理由: やりたくない) ← 不適切な理由（違反）
- 📋 パスワードリセット (理由: メール機能前提) ← 📋に理由記載（間違い）
```

#### ✅ 正しい記載例
```markdown
## プロセス遵守例（実装保留）
- ⏸️ ユーザー登録機能 (理由: ログイン機能完了・テスト後に実装) - 再開条件: login.test.tsx成功
- ⏸️ UI改善 (理由: MVP完成後のPhase2として実施予定) - 再開条件: 基本機能の完全テスト完了
- ⏸️ 自動テスト (理由: React Router v7の技術的制約により手動テストで代替) - 再開条件: テスト環境問題の解決策確立

## プロセス遵守例（実装予定）
- 📋 商品詳細画面コンポーネント (app/routes/products.$id.tsx)
- 📋 ユーザープロフィール編集機能 (app/routes/profile.tsx)
- 📋 検索・フィルター機能 (app/components/SearchFilter.tsx)
```

## 24. プロジェクトドキュメントガイド

プロジェクトには`.claude/`ディレクトリに包括的なドキュメントがあります。各ドキュメントをいつ参照すべきかを示します。

### 📋 00_project - プロジェクトコンセプトと要件

#### ビジネス要件
- **`.claude/00_project/01_nanika_concept_requirements.md`** - ビジネス要件と機能仕様
- **`.claude/00_project/02_inception_deck.md`** - プロジェクトビジョンと目標
- **使用する場面**: ビジネスロジック、機能要件、またはプロジェクト目標の理解時

#### 仕様書と開発プロセス
- **`.claude/00_project/docs/機能名-spec.md`** - 各機能の仕様書
- **`.claude/00_project/development-process/機能名-process.md`** - 各機能の開発プロセスとプログレス管理
- **使用する場面**: 新機能実装、TDDプロセス、進捗管理時

#### 分析・改善レポート
- **`.claude/00_project/reports/communication-improvement-analysis.md`** - コミュニケーション改善分析
- **`.claude/00_project/reports/performance/`** - パフォーマンス分析レポート
- **使用する場面**: 開発プロセスの改善検討、パフォーマンス最適化時

### 🏗️ 01_development_docs - 技術設計ドキュメント

#### システムアーキテクチャ
- **`.claude/01_development_docs/01_architecture_design.md`** - DDDとクリーンアーキテクチャの実装詳細
- **使用する場面**: レイヤーの責任の理解、新機能の追加、リファクタリング時

#### データベース設計
- **`.claude/01_development_docs/02_database_design.md`** - 完全なER図とテーブル定義
- **使用する場面**: データベースクエリの作業、新しいテーブル/カラムの追加、関係の理解時

#### API設計
- **`.claude/01_development_docs/03_api_design.md`** - RESTful APIエンドポイントと契約
- **使用する場面**: 新しいエンドポイントの実装、リクエスト/レスポンス形式の理解時

#### フロントエンド設計
- **`.claude/01_development_docs/04_screen_transition_design.md`** - 画面フローとUI構造
- **`.claude/01_development_docs/10_frontend_design.md`** - コンポーネントパターンとフロントエンドアーキテクチャ
- **使用する場面**: 新しいページの作成、UIコンポーネントの実装、ナビゲーションの理解時

#### SEO要件
- **`.claude/01_development_docs/05_seo_requirements.md`** - SEO最適化戦略
- **使用する場面**: SEOを考慮したページの実装、メタタグの作業時

#### エラーハンドリング
- **`.claude/01_development_docs/06_error_handling_design.md`** - エラーハンドリングパターンと戦略
- **使用する場面**: エラーハンドリングの実装、カスタムエラークラスの作成時

#### 型定義
- **`.claude/01_development_docs/07_type_definitions.md`** - TypeScript型システム設計
- **使用する場面**: 新しい型の作成、ドメインモデルの理解時

#### 開発セットアップ
- **`.claude/01_development_docs/08_development_setup.md`** - 環境セットアップと開発ワークフロー
- **使用する場面**: ローカル環境のセットアップ、開発コマンドの理解時

#### テスト戦略
- **`.claude/01_development_docs/09_test_strategy.md`** - TDDアプローチとテストパターン
- **使用する場面**: テストの作成、テスト構造の理解、TDDの実装時

#### CI/CD
- **`.claude/01_development_docs/11_cicd_design.md`** - GitHub Actionsとデプロイパイプライン
- **使用する場面**: CI/CDワークフローの変更、デプロイプロセスの理解時

#### E2Eテスト
- **`.claude/01_development_docs/12_e2e_test_design.md`** - E2Eテスト設計（Playwright、エラー監視、クリティカルパス）
- **使用する場面**: E2Eテスト実装、ブラウザテスト作成、エラー監視の設定時

#### セキュリティ
- **`.claude/01_development_docs/13_security_design.md`** - セキュリティ設計（認証、入力検証、ファイルアップロード）
- **使用する場面**: セキュリティ実装、認証・認可、ファイルアップロード機能の実装時

#### パフォーマンス
- **`.claude/01_development_docs/14_performance_optimization.md`** - パフォーマンス最適化（Core Web Vitals、画像最適化、キャッシュ戦略）
- **`.claude/01_development_docs/15_performance_monitoring.md`** - パフォーマンス計測・監視（Lighthouse、Web Vitals、プロセス管理）
- **使用する場面**: パフォーマンス改善、SEO対策、画像処理の実装時、継続的な監視体制の構築時

### 🎨 02_design_system - デザインシステム
- **`.claude/02_design_system/00_basic_design.md`** - デザインシステム概要とクイックスタート
- **`.claude/02_design_system/01_design_principles.md`** - デザイン原則、カラーシステム、タイポグラフィ
- **`.claude/02_design_system/02_component_design.md`** - UIコンポーネント設計
- **`.claude/02_design_system/02_layout_system.md`** - レイアウトシステムとグリッド設計
- **`.claude/02_design_system/03_animation_system.md`** - アニメーションパターンと実装
- **使用する場面**: UI実装、コンポーネント作成、スタイリング、アニメーション実装時

### 📚 03_library_docs - ライブラリドキュメント
- **`.claude/03_library_docs/01_react_router_patterns.md`** - React Routerパターン集（ローダー、アクション、エラーバウンダリー）
- **`.claude/03_library_docs/02_vitest_testing.md`** - Vitestテスト方法（モック戦略、環境設定）
- **`.claude/03_library_docs/03_prisma_patterns.md`** - Prismaパターンとベストプラクティス
- **`.claude/03_library_docs/04_tailwind_utilities.md`** - Tailwind CSSユーティリティとカスタマイズ
- **使用する場面**:
  - React Router実装時、ルーティング設計時
  - テスト作成時、モック実装時
  - データベース操作実装時
  - スタイリング、レスポンシブデザイン実装時


### クイックリファレンスマップ

| タスク | 主要ドキュメント |
|------|------------------|
| 新機能の追加 | アーキテクチャ → データベース → API → フロントエンド設計 |
| 新しいAPIエンドポイントの作成 | API設計 → エラーハンドリング → 型定義 |
| データベース変更 | データベース設計 → 型定義 |
| UI実装 | フロントエンド設計 → デザインシステム → コンポーネント設計 |
| スタイリング・アニメーション | デザイン原則 → コンポーネント設計 → アニメーションシステム |
| React Routerコンポーネント実装 | React Routerパターン → フロントエンド設計 |
| テストの作成 | テスト戦略 → アーキテクチャ（レイヤー別） |
| Vitestテスト実装 | テスト戦略 → Vitestテスト方法 |
| E2Eテスト実装 | E2Eテスト設計 → テスト戦略 |
| セキュリティ実装 | セキュリティ設計 → 認証パターン |
| パフォーマンス改善 | パフォーマンス最適化 → SEO要件 |
| パフォーマンス監視 | パフォーマンス監視 → パフォーマンス最適化 |
| デプロイ/CI | CI/CD設計 → 開発セットアップ |
| エラーハンドリング | エラーハンドリング → 型定義 |
| SEO実装 | SEO要件 → パフォーマンス最適化 |

---

以上のルールを遵守し、**透明性の高い作業管理**、**効率的なコミュニケーション**、**高品質なコード**を共に作り上げていきましょう。